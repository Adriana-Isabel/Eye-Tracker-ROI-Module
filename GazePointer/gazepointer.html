<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gaze Pointer + Fixation Tracking</title>
  <style>
    body {
      margin: 0;
      background: #111;
      color: #fff;
      overflow: hidden;
      font-family: sans-serif;
    }
    #video {
      position: fixed;
      right: 10px;
      bottom: 10px;
      width: 200px;
      opacity: 0.3;
    }
    #cursorDot {
      position: absolute;
      width: 20px;
      height: 20px;
      background: red;
      border-radius: 50%;
      pointer-events: none;
      transform: translate(-50%, -50%);
    }
    #controls {
      position: fixed;
      top: 10px;
      left: 10px;
      z-index: 10;
      background: rgba(0,0,0,0.5);
      padding: 10px;
      border-radius: 6px;
    }
    button {
      margin-right: 10px;
      padding: 8px 12px;
      border: none;
      border-radius: 4px;
      background: #444;
      color: #fff;
      cursor: pointer;
    }
    button:disabled{ opacity: 0.45; cursor: default; }
    .dwell-progress{ position: absolute; inset: 0; pointer-events:none; border-radius:4px; background: linear-gradient(90deg, rgba(255,255,255,0.18) 0%, rgba(255,255,255,0.18) 0%, transparent 0%); }
  </style>
  <script src="https://webgazer.cs.brown.edu/webgazer.js"></script>
</head>
<body>

<div id="controls">
  <button id="startBtn">Start Recording<div class="dwell-progress" style="display:none"></div></button>
  <button id="stopBtn">Stop Recording<div class="dwell-progress" style="display:none"></div></button>
  <button id="downloadBtn">Download CSV<div class="dwell-progress" style="display:none"></div></button>
</div>

<div id="cursorDot"></div>
<video id="video" autoplay playsinline></video>

<script>
  let isRecording = false;
  let dataLog = [];
  let fixationStart = null;
  let lastPos = null;
  let fixationThreshold = 80; // px radius
  let fixationMinTime = 500; // ms

  async function initCamera() {
    const video = document.getElementById('video');
    const stream = await navigator.mediaDevices.getUserMedia({ video: true });
    video.srcObject = stream;
  }

  function distance(a, b) {
    return Math.sqrt((a.x - b.x) ** 2 + (a.y - b.y) ** 2);
  }

  function startWebGazer() {
    webgazer.setGazeListener((data, timestamp) => {
      if (!data) return;
      const x = data.x;
      const y = data.y;
      // reliable timestamp (WebGazer may not provide one); prefer performance.now()
      const now = (typeof timestamp === 'number' && isFinite(timestamp)) ? timestamp : performance.now();

      // Move dot
      const dot = document.getElementById('cursorDot');
      dot.style.left = x + 'px';
      dot.style.top = y + 'px';

      // Fixation detection
      if (!lastPos) lastPos = { x, y };
      const d = distance({ x, y }, lastPos);

      let isFixating = false;
      let fixationDuration = 0;

      if (d < fixationThreshold) {
        if (!fixationStart) fixationStart = now;
        fixationDuration = now - fixationStart;
        if (fixationDuration >= fixationMinTime) isFixating = true;
      } else {
        fixationStart = null;
      }

      lastPos = { x, y };

      if (isRecording) {
        dataLog.push({ timestamp: now, x, y, isFixating, fixationDuration });
      }
      // handle gaze-based button activation (dwell)
      handleGaze(x,y,now);
    }).begin();
  }

  function downloadCSV() {
    let csv = 'timestamp,x,y,isFixating,fixationDuration\n';
    dataLog.forEach(row => {
      csv += `${row.timestamp},${row.x},${row.y},${row.isFixating},${row.fixationDuration}\n`;
    });

    // no-fixation summary removed

    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'gaze_data.csv';
    a.click();
  }

  document.getElementById('startBtn').onclick = () => {
    isRecording = true;
    dataLog = [];
    updateButtons();
  };

  document.getElementById('stopBtn').onclick = () => {
    isRecording = false;
    updateButtons();
  };

  document.getElementById('downloadBtn').onclick = downloadCSV;

  initCamera();
  startWebGazer();

  // ---- gaze-to-button (dwell) logic ----
  const dwellTime = 800; // ms required to activate
  let gazeTarget = null; // element
  let dwellStart = 0;
  let lastActivated = 0;

  function updateButtons(){
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    startBtn.disabled = !!isRecording;
    stopBtn.disabled = !isRecording;
  }
  updateButtons();

  function setDwellProgress(el, frac){
    const prog = el.querySelector('.dwell-progress');
    if(!prog) return;
    if(frac <= 0){ prog.style.display = 'none'; return; }
    prog.style.display = 'block';
    const pct = Math.min(100, Math.round(frac*100));
    prog.style.background = `linear-gradient(90deg, rgba(255,255,255,0.18) 0%, rgba(255,255,255,0.18) ${pct}%, transparent ${pct}%)`;
  }

  function handleGaze(x,y,timestamp){
    // find first control button under gaze
    const controls = document.getElementById('controls');
    const buttons = Array.from(controls.querySelectorAll('button'));
    let found = null;
    for(const b of buttons){
      const r = b.getBoundingClientRect();
      if(x >= r.left && x <= r.right && y >= r.top && y <= r.bottom){ found = b; break; }
    }

    if(found !== gazeTarget){
      // left previous target
      if(gazeTarget) setDwellProgress(gazeTarget, 0);
      gazeTarget = found;
      dwellStart = timestamp || performance.now();
      return;
    }

    if(!gazeTarget) return;
    // only allow activation if button is enabled
    if(gazeTarget.disabled) { setDwellProgress(gazeTarget, 0); return; }

    const elapsed = (timestamp || performance.now()) - dwellStart;
    const frac = Math.max(0, Math.min(1, elapsed / dwellTime));
    setDwellProgress(gazeTarget, frac);

    if(elapsed >= dwellTime){
      // avoid rapid re-activation
      if(performance.now() - lastActivated > 900){
        gazeTarget.click();
        lastActivated = performance.now();
      }
      // reset
      setDwellProgress(gazeTarget, 0);
      dwellStart = performance.now() + 50;
    }
  }
</script>

</body>
</html>
