<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Gazepoint-style (Webcam) — Fixation & Object Logging (Polished)</title>
<style>
  :root {
    --bg: #0f1113;
    --panel: rgba(255,255,255,0.04);
    --muted: #cfd8dc;
  }
  html,body{height:100%;margin:0;background:var(--bg);color:#fff;font-family:Inter,system-ui,Segoe UI,Arial;}
  #controls{
    position:fixed;left:12px;top:12px;padding:12px;border-radius:10px;background:var(--panel);z-index:1000;max-width:calc(100% - 40px);
  }
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:6px}
  button{margin:0;padding:8px 12px;border-radius:6px;border:0;background:#2b2f33;color:#fff;cursor:pointer}
  button:disabled{opacity:.45;cursor:not-allowed}
  input[type="range"]{width:140px}
  label.small{font-size:12px;color:#c7c7c7}
  #video{position:fixed;right:10px;bottom:10px;width:200px;opacity:0.28;z-index:1000;border-radius:6px;box-shadow:0 6px 24px rgba(0,0,0,.6)}
  #cursorDot{
    position:fixed;left:50%;top:50%;width:18px;height:18px;border-radius:50%;
    background:#ff4d4d;pointer-events:none;transform:translate(-50%,-50%) scale(1);
    box-shadow:0 6px 14px rgba(0,0,0,0.5);z-index:999;transition:width .08s linear,height .08s linear;
  }
  #rawDot{
    position:fixed;left:50%;top:50%;width:10px;height:10px;border-radius:50%;
    background:#4ea3ff;pointer-events:none;transform:translate(-50%,-50%);box-shadow:0 6px 14px rgba(0,0,0,0.5);
    z-index:998;display:none;
  }
  .target{
    position:absolute;width:160px;height:120px;border-radius:8px;display:flex;align-items:center;justify-content:center;
    color:white;font-weight:600;box-shadow:0 8px 24px rgba(0,0,0,.6)
  }
  #targetA{left:120px;top:140px;background:#1e88e5}
  #targetB{left:420px;top:200px;background:#43a047}
  #targetC{left:760px;top:120px;background:#f4511e}
  #status{font-size:12px;color:#c7c7c7;margin-top:6px}
  .muted{color: #9fb2c7; font-size:12px}
  @media (max-width:800px){
    .target{width:120px;height:90px}
  }
</style>

<!-- WebGazer -->
<script src="https://webgazer.cs.brown.edu/webgazer.js"></script>
</head>
<body>

<div id="controls">
  <div class="row">
    <button id="startBtn">Start Recording</button>
    <button id="stopBtn" disabled>Stop Recording</button>
    <button id="downloadBtn">Download CSV</button>

    <button id="calibrateBtn">Clear / Recalibrate</button>
  </div>

  <div class="row">
    <label class="small">Smooth factor:</label>
    <input id="sfSlider" type="range" min="0.02" max="0.6" step="0.01" value="0.12">
    <label class="small muted" id="sfVal">0.12</label>

    <label style="margin-left:12px" class="small">Display smooth (ms):</label>
    <input id="dsSlider" type="range" min="10" max="300" step="5" value="80">
    <label class="small muted" id="dsVal">80</label>
  </div>

  <div class="row">
    <button id="presetResp">Responsive</button>
    <button id="presetBal">Balanced</button>
    <button id="presetStable">Stable</button>

    <label style="margin-left:12px"><input id="twoStageChk" type="checkbox"> Median+EMA filter</label>

    <label class="small" style="margin-left:8px">Median N:</label>
    <input id="medNSlider" type="range" min="3" max="11" step="2" value="5">
    <label class="small muted" id="medNVal">5</label>

    <label class="small" style="margin-left:8px">EMA α:</label>
    <input id="emaSlider" type="range" min="0.02" max="0.5" step="0.01" value="0.12">
    <label class="small muted" id="emaVal">0.12</label>

    <label style="margin-left:12px"><input id="showRawChk" type="checkbox"> Show raw dot</label>
  </div>

  <div id="status" class="small">Status: <span id="statText">idle</span></div>
  <div class="small" id="statDetails"></div>
</div>

<!-- Visual elements -->
<div id="cursorDot"></div>
<div id="rawDot"></div>
<video id="video" autoplay playsinline muted></video>

<!-- Example gaze targets -->
<div id="targetA" class="target">Blue Box</div>
<div id="targetB" class="target">Green Box</div>
<div id="targetC" class="target">Orange Box</div>

<script>
/* =========================
   Polished Eye-tracking demo
   - Clean structure
   - Two-stage optional filter (median -> EMA)
   - Exponential display smoothing (time-constant in ms)
   - Fixation detection and object logging
   - CSV export
   ========================= */

/* -------------------------
   Configurable parameters
   ------------------------- */
let SMOOTH_FACTOR = 0.12;      // raw sample EMA smoothing (0..1)
let DISPLAY_SMOOTH_MS = 80;   // display interpolation time-constant in ms

const VELOCITY_THRESHOLD = 0.36; // px / ms threshold for 'stable' movement
const RADIUS_THRESHOLD = 45;     // px for spatial stability
const MIN_FIX_TIME = 300;        // ms for fixation start
const DWELL_TIME = 800;          // ms for dwell activation (if used)

// Offsets to tweak if dot is consistently shifted on user's screen
const OFFSET_X = 0;
const OFFSET_Y = 0;

/* -------------------------
   Runtime state
   ------------------------- */
let isRecording = false;
let dataLog = []; // array of samples logged while recording

// Raw smoothing / filter state
let smoothX = null, smoothY = null;
let prevX = null, prevY = null, prevTime = null;
let velocity = 0;

// Fixation detection
let fixTimer = null;
let isFixating = false;
let fixationStartTime = null;
let fixationX = null, fixationY = null;

let totalNoFixationTime = 0;
let noFixationStart = null;

// Visual interpolation state
let visX = window.innerWidth / 2, visY = window.innerHeight / 2;
let targetVisX = visX, targetVisY = visY;
let _lastAnimTime = performance.now();

// Targets for object detection (populated after DOM ready)
let gazeTargets = [];

/* Two-stage filter (optional)
   median buffer + EMA */
let twoStageEnabled = false;
let MEDIAN_WINDOW = 5;
let EMA_ALPHA = 0.12;
let medianBuf = [];
let emaX = null, emaY = null;
let showRawDot = false;

/* Helpers */
const nowMs = () => performance.now();
function clamp(v, a, b){ return Math.max(a, Math.min(b, v)); }

/* -------------------------
   Camera preview (small)
   ------------------------- */
async function initCameraPreview(){
  try{
    const v = document.getElementById('video');
    const s = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
    v.srcObject = s;
  }catch(e){
    console.warn('camera preview failed', e);
  }
}

/* -------------------------
   Gaze-target registration
   ------------------------- */
function initGazeTargets(){
  gazeTargets = [
    {id: 'targetA', element: document.getElementById('targetA')},
    {id: 'targetB', element: document.getElementById('targetB')},
    {id: 'targetC', element: document.getElementById('targetC')}
  ];
}

/* -------------------------
   WebGazer initialization
   ------------------------- */
function startWebGazer(){
  // Basic visual cleanup + choose regression
  webgazer
    .showVideoPreview(false)
    .showPredictionPoints(false)
    .applyKalmanFilter(false) // rely on our own smoothing
    .setRegression('ridge');

  // Listener receives raw predictions from webgazer
  webgazer.setGazeListener((data, timestamp) => {
    if(!data) return;
    const tstamp = (typeof timestamp === 'number' && isFinite(timestamp)) ? timestamp : nowMs();

    // --- Raw smoothing (single-pole low-pass on webgazer samples) ---
    if(smoothX === null){
      smoothX = data.x;
      smoothY = data.y;
    } else {
      // EMA smoothing of raw prediction
      smoothX += SMOOTH_FACTOR * (data.x - smoothX);
      smoothY += SMOOTH_FACTOR * (data.y - smoothY);
    }

    const rawX = smoothX;
    const rawY = smoothY;

    // --- Two-stage median + EMA filter (optional) ---
    let fx = rawX, fy = rawY;
    if(twoStageEnabled){
      // push into circular-ish buffer
      medianBuf.push({x: rawX, y: rawY});
      if(medianBuf.length > MEDIAN_WINDOW) medianBuf.shift();

      const xs = medianBuf.map(p => p.x).slice().sort((a,b)=>a-b);
      const ys = medianBuf.map(p => p.y).slice().sort((a,b)=>a-b);
      const mid = Math.floor(xs.length/2);
      const medX = xs.length % 2 === 1 ? xs[mid] : (xs[mid-1] + xs[mid]) / 2;
      const medY = ys.length % 2 === 1 ? ys[mid] : (ys[mid-1] + ys[mid]) / 2;

      if(emaX === null){ emaX = medX; emaY = medY; }
      else { emaX += EMA_ALPHA * (medX - emaX); emaY += EMA_ALPHA * (medY - emaY); }

      fx = emaX; fy = emaY;
    } else {
      // reset when disabled to avoid stale state
      if(medianBuf.length) medianBuf = [];
      emaX = emaY = null;
    }

    // Apply optional screen offsets
    const x = fx + OFFSET_X;
    const y = fy + OFFSET_Y;

    // --- Velocity (px per ms) ---
    if(prevX !== null && prevY !== null && prevTime !== null){
      const dt = Math.max(1, tstamp - prevTime);
      velocity = Math.hypot(x - prevX, y - prevY) / dt;
    } else {
      velocity = 0;
    }
    prevX = x; prevY = y; prevTime = tstamp;

    // --- Fixation detection (Gazepoint-style) ---
    let spatialStable = true;
    if(fixationX !== null){
      spatialStable = Math.hypot(x - fixationX, y - fixationY) < RADIUS_THRESHOLD;
    }
    const velocityStable = velocity < VELOCITY_THRESHOLD;

    if(spatialStable && velocityStable){
      if(!fixTimer) fixTimer = tstamp;
      if(!isFixating && (tstamp - fixTimer) >= MIN_FIX_TIME){
        // fixation ON
        isFixating = true;
        fixationStartTime = tstamp;
        fixationX = x;
        fixationY = y;
        if(noFixationStart){
          totalNoFixationTime += (tstamp - noFixationStart);
          noFixationStart = null;
        }
      } else if(isFixating){
        // slowly update centroid to allow micro drift
        fixationX += 0.06 * (x - fixationX);
        fixationY += 0.06 * (y - fixationY);
      }
    } else {
      // not stable -> break fixation
      if(isFixating){
        isFixating = false;
        fixationStartTime = null;
      }
      fixTimer = null;
      // gently move centroid toward current
      fixationX = x;
      fixationY = y;
      if(isRecording && !noFixationStart) noFixationStart = tstamp;
    }

    // --- Object detection (which element is under gaze) ---
    let lookedAt = 'none';
    for(const obj of gazeTargets){
      const r = obj.element.getBoundingClientRect();
      if(x >= r.left && x <= r.right && y >= r.top && y <= r.bottom){
        lookedAt = obj.id;
        break;
      }
    }

    // --- Show debug raw dot (optional) ---
    if(showRawDot){
      const rd = document.getElementById('rawDot');
      rd.style.display = 'block';
      const clampedRX = clamp(rawX + OFFSET_X, 0, window.innerWidth);
      const clampedRY = clamp(rawY + OFFSET_Y, 0, window.innerHeight);
      rd.style.left = clampedRX + 'px';
      rd.style.top = clampedRY + 'px';
    }

    // --- Logging while recording ---
    if(isRecording){
      let noFixDur = 0;
      if(!isFixating && noFixationStart) noFixDur = Math.round(tstamp - noFixationStart);

      dataLog.push({
        timestamp: tstamp,
        x: Math.round(x),
        y: Math.round(y),
        isFixating: !!isFixating,
        fixationDuration: isFixating && fixationStartTime ? Math.round(tstamp - fixationStartTime) : 0,
        noFixationDuration: noFixDur,
        fixationX: fixationX !== null ? Math.round(fixationX) : '',
        fixationY: fixationY !== null ? Math.round(fixationY) : '',
        velocity,
        lookedAt
      });
    }

    // --- Update visual target for dot interpolation ---
    targetVisX = x;
    targetVisY = y;

    // Update tiny status HUD
    updateStatusUI({isFixating, velocity, lookedAt});
  });

  // Start webgazer's internal loop
  webgazer.begin();
}

/* -------------------------
   Smooth dot animation
   Uses an exponential smoothing based on time-constant (ms).
   alpha = 1 - exp(-dt / tau)
   ------------------------- */
function animateDot(timestamp){
  if(!timestamp) timestamp = performance.now();
  const dt = Math.max(0, timestamp - _lastAnimTime);
  _lastAnimTime = timestamp;

  // If DISPLAY_SMOOTH_MS is 0 or tiny, jump immediately (avoid div by 0)
  const tau = Math.max(1, DISPLAY_SMOOTH_MS);
  const alpha = 1 - Math.exp(-dt / tau);

  visX += (targetVisX - visX) * alpha;
  visY += (targetVisY - visY) * alpha;

  const clampedX = clamp(visX, 0, window.innerWidth);
  const clampedY = clamp(visY, 0, window.innerHeight);

  const cursor = document.getElementById('cursorDot');
  cursor.style.left = clampedX + 'px';
  cursor.style.top = clampedY + 'px';

  cursor.style.transform = isFixating ? 'translate(-50%,-50%) scale(0.9)' : 'translate(-50%,-50%) scale(1)';
  cursor.style.width = isFixating ? '16px' : '18px';
  cursor.style.height = isFixating ? '16px' : '18px';

  requestAnimationFrame(animateDot);
}

/* -------------------------
   CSV export
   ------------------------- */
function downloadCSV(){
  if(noFixationStart){
    totalNoFixationTime += (nowMs() - noFixationStart);
    noFixationStart = null;
  }

  let csv = 'timestamp,x,y,isFixating,fixationDuration,noFixationDuration,fixationX,fixationY,velocity,lookedAt\n';
  for(const r of dataLog){
    csv += `${r.timestamp},${r.x},${r.y},${r.isFixating},${r.fixationDuration},${r.noFixationDuration || 0},${r.fixationX},${r.fixationY},${r.velocity},${r.lookedAt}\n`;
  }
  csv += `\nTotal_No_Fixation_Time_ms,${Math.round(totalNoFixationTime)}\n`;

  const blob = new Blob([csv], {type:'text/csv'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `gaze_log_${Date.now()}.csv`;
  a.click();
  URL.revokeObjectURL(url);
}

/* -------------------------
   UI wiring
   ------------------------- */
const startBtn = document.getElementById('startBtn');
const stopBtn = document.getElementById('stopBtn');
const downloadBtn = document.getElementById('downloadBtn');
const calibrateBtn = document.getElementById('calibrateBtn');
const statText = document.getElementById('statText');
const statDetails = document.getElementById('statDetails');

startBtn.onclick = () => {
  isRecording = true;
  dataLog = [];
  totalNoFixationTime = 0;
  noFixationStart = null;

  // Clear webgazer's stored data so calibration starts fresh
  try{ webgazer.clearData(); }catch(e){ /* ignore */ }

  statText.innerText = 'recording';
  updateButtons();
};

stopBtn.onclick = () => {
  isRecording = false;
  if(noFixationStart){
    totalNoFixationTime += (nowMs() - noFixationStart);
    noFixationStart = null;
  }
  statText.innerText = 'idle';
  updateButtons();
};

downloadBtn.onclick = downloadCSV;

calibrateBtn.onclick = () => {
  // Clear previous webgazer data (makes it re-learn)
  try{
    webgazer.clearData();
    // optional: show a small visual instruction to the user to look around
    alert('WebGazer data cleared. Move your head and look around the screen for a few seconds to help recalibration.');
  }catch(e){
    console.warn('calibrate failed', e);
  }
};

function updateButtons(){
  startBtn.disabled = isRecording;
  stopBtn.disabled = !isRecording;
}

/* Update HUD */
function updateStatusUI({isFixating, velocity, lookedAt}){
  statText.innerText = isRecording ? (isFixating ? 'fixating' : 'scanning') : 'idle';
  statDetails.innerText = `vel: ${velocity.toFixed(3)} px/ms · fix:${isFixating ? 'YES' : 'NO'} · target:${lookedAt}`;
}

/* -------------------------
   Controls (sliders / presets)
   ------------------------- */
(function wireControls(){
  const sfSlider = document.getElementById('sfSlider'), sfVal = document.getElementById('sfVal');
  const dsSlider = document.getElementById('dsSlider'), dsVal = document.getElementById('dsVal');
  const medNSlider = document.getElementById('medNSlider'), medNVal = document.getElementById('medNVal');
  const emaSlider = document.getElementById('emaSlider'), emaVal = document.getElementById('emaVal');
  const twoStageChk = document.getElementById('twoStageChk'), showRawChk = document.getElementById('showRawChk');
  const presetResp = document.getElementById('presetResp'), presetBal = document.getElementById('presetBal'), presetStable = document.getElementById('presetStable');

  // slider events
  sfSlider.oninput = () => { SMOOTH_FACTOR = parseFloat(sfSlider.value); sfVal.innerText = SMOOTH_FACTOR.toFixed(2); };
  dsSlider.oninput = () => { DISPLAY_SMOOTH_MS = parseInt(dsSlider.value); dsVal.innerText = DISPLAY_SMOOTH_MS; };
  medNSlider.oninput = () => { MEDIAN_WINDOW = parseInt(medNSlider.value); medNVal.innerText = MEDIAN_WINDOW; };
  emaSlider.oninput = () => { EMA_ALPHA = parseFloat(emaSlider.value); emaVal.innerText = EMA_ALPHA.toFixed(2); };
  twoStageChk.onchange = () => { twoStageEnabled = twoStageChk.checked; if(!twoStageEnabled){ medianBuf=[]; emaX=emaY=null; } };
  showRawChk.onchange = () => { showRawDot = showRawChk.checked; document.getElementById('rawDot').style.display = showRawDot ? 'block' : 'none'; };

  // presets
  presetResp.onclick = () => {
    sfSlider.value = 0.35; dsSlider.value = 30; twoStageChk.checked = false;
    sfSlider.oninput(); dsSlider.oninput(); twoStageChk.onchange();
  };
  presetBal.onclick = () => {
    sfSlider.value = 0.12; dsSlider.value = 80; twoStageChk.checked = true; medNSlider.value = 5; emaSlider.value = 0.12;
    sfSlider.oninput(); dsSlider.oninput(); medNSlider.oninput(); emaSlider.oninput(); twoStageChk.onchange();
  };
  presetStable.onclick = () => {
    sfSlider.value = 0.06; dsSlider.value = 150; twoStageChk.checked = true; medNSlider.value = 7; emaSlider.value = 0.08;
    sfSlider.oninput(); dsSlider.oninput(); medNSlider.oninput(); emaSlider.oninput(); twoStageChk.onchange();
  };

  // initialize displayed values
  sfVal.innerText = SMOOTH_FACTOR.toFixed(2);
  dsVal.innerText = DISPLAY_SMOOTH_MS;
  medNVal.innerText = MEDIAN_WINDOW;
  emaVal.innerText = EMA_ALPHA.toFixed(2);
})();

/* -------------------------
   Startup
   ------------------------- */
window.addEventListener('load', () => {
  initCameraPreview();
  initGazeTargets();
  startWebGazer();
  requestAnimationFrame(animateDot);
  updateButtons();
});

/* Cleanup */
window.addEventListener('beforeunload', () => {
  try{ webgazer.end(); }catch(e){}
});

/* Handle window resizes so clamping stays correct */
window.addEventListener('resize', () => {
  visX = clamp(visX, 0, window.innerWidth);
  visY = clamp(visY, 0, window.innerHeight);
});
</script>

</body>
</html>
